<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lynxes - Log-Based Message Streaming System Dashboard</title>
    
    <!-- Only Tailwind CSS for basic styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Minimal custom styles - no animations, no heavy effects */
        * {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            background: #f8fafc;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }
        
        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .btn:hover {
            background: #2563eb;
        }
        
        .btn-danger {
            background: #ef4444;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-secondary {
            background: #6b7280;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .input {
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 14px;
        }
        
        .input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        
        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 12px;
            font-weight: 500;
        }
        
        .alert-success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        
        .alert-error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        
        .alert-info {
            background: #eff6ff;
            color: #2563eb;
            border: 1px solid #bfdbfe;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .status-online {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-offline {
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                        <span class="text-white font-bold text-sm">L</span>
                    </div>
                    <h1 class="text-xl font-semibold text-gray-900">Lynxes</h1>
                    <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">Streaming System</span>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <span class="status-online" id="server-status-indicator"></span>
                        <span class="text-sm font-medium text-gray-700" id="server-status">Online</span>
                    </div>
                    <div class="text-sm text-gray-500">
                        <span id="uptime">2h 15m</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-6 py-8">
        <!-- Metrics Overview -->
        <section class="mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Overview</h2>
            <div class="grid grid-cols-1 gap-6">
                <!-- Active Topics -->
                <div class="card p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-2xl font-bold text-gray-900" id="topic-count">0</div>
                            <div class="text-sm text-gray-500">Active Topics</div>
                        </div>
                        <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                            <span class="text-orange-600 font-bold">üìÅ</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Topics Management -->
        <section class="mb-8">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Topics</h2>
                <div class="flex space-x-3">
                    <button onclick="showCreateTopicModal()" class="btn">
                        + Create Topic
                    </button>
                    <button onclick="showDeleteAllTopicsModal()" class="btn btn-danger">
                        üóëÔ∏è Delete All
                    </button>
                </div>
            </div>

            <!-- Topics Grid -->
            <div id="topics-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Topics will be dynamically loaded here -->
            </div>
        </section>

        <!-- Message Operations -->
        <section class="mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Message Operations</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Publish Message -->
                <div class="card p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">üì§ Publish Message</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Topic</label>
                            <select id="publish-topic-select" class="input w-full">
                                <option value="">Select a topic...</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Message</label>
                            <textarea id="publish-message" class="input w-full h-20 resize-none" placeholder="Enter your message..."></textarea>
                        </div>
                        
                        <button onclick="publishMessage()" class="btn w-full">
                            Publish Message
                        </button>
                    </div>
                </div>

                <!-- Consume Message -->
                <div class="card p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">üì• Consume Message</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Topic</label>
                            <select id="consume-topic-select" class="input w-full">
                                <option value="">Select a topic...</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Offset</label>
                            <input type="number" id="consume-offset" class="input w-full" placeholder="0" min="0">
                        </div>
                        
                        <button onclick="consumeMessage()" class="btn btn-secondary w-full">
                            Consume Message
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Alerts Container -->
    <div id="alerts-container" class="fixed top-20 right-6 z-50 space-y-3"></div>

    <!-- Create Topic Modal -->
    <div id="create-topic-modal" class="modal">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-900">Create New Topic</h3>
                <button onclick="hideCreateTopicModal()" class="text-gray-400 hover:text-gray-600">
                    ‚úï
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Topic Name</label>
                    <input type="text" id="new-topic-name" class="input w-full" placeholder="Enter topic name...">
                </div>
                
                <div class="flex space-x-3 pt-4">
                    <button onclick="createTopic()" class="btn flex-1">
                        Create Topic
                    </button>
                    <button onclick="hideCreateTopicModal()" class="btn btn-secondary flex-1">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete All Topics Modal -->
    <div id="delete-all-topics-modal" class="modal">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-900">Delete All Topics</h3>
                <button onclick="hideDeleteAllTopicsModal()" class="text-gray-400 hover:text-gray-600">
                    ‚úï
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="p-4 bg-red-50 rounded-lg border border-red-200">
                    <div class="font-medium text-red-800">‚ö†Ô∏è Warning</div>
                    <div class="text-sm text-red-600">This will permanently delete all topics and their messages.</div>
                </div>
                
                <div class="flex space-x-3 pt-4">
                    <button onclick="deleteAllTopics()" class="btn btn-danger flex-1">
                        Delete All
                    </button>
                    <button onclick="hideDeleteAllTopicsModal()" class="btn btn-secondary flex-1">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Topic Details Modal -->
    <div id="topic-details-modal" class="modal">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-900">Topic Details</h3>
                <button onclick="hideTopicDetailsModal()" class="text-gray-400 hover:text-gray-600">
                    ‚úï
                </button>
            </div>
            
            <div id="topic-details-content" class="space-y-4">
                <!-- Topic details will be loaded here -->
            </div>
            
            <div class="flex space-x-3 pt-6">
                <button onclick="deleteTopic()" class="btn btn-danger flex-1">
                    Delete Topic
                </button>
                <button onclick="hideTopicDetailsModal()" class="btn btn-secondary flex-1">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentTopicForDeletion = null;

        // Show alert function
        function showAlert(message, type = 'info') {
            const alertsContainer = document.getElementById('alerts-container');
            const alertId = 'alert-' + Date.now();
            
            const alertClass = type === 'success' ? 'alert-success' : 
                              type === 'error' ? 'alert-error' : 'alert-info';
            
            const alertHtml = `
                <div id="${alertId}" class="alert ${alertClass}">
                    <div class="flex items-center justify-between">
                        <span>${message}</span>
                        <button onclick="hideAlert('${alertId}')" class="text-current opacity-70 hover:opacity-100">
                            ‚úï
                        </button>
                    </div>
                </div>
            `;
            
            alertsContainer.insertAdjacentHTML('beforeend', alertHtml);
            
            // Auto-hide after 5 seconds
            setTimeout(() => hideAlert(alertId), 5000);
        }

        function hideAlert(alertId) {
            const alert = document.getElementById(alertId);
            if (alert) {
                alert.remove();
            }
        }

        // Track uptime locally to avoid frequent backend calls
        let currentUptimeSeconds = 0;
        let uptimeInterval = null;
        
        function parseUptimeToSeconds(uptimeString) {
            if (!uptimeString || uptimeString === 'Unknown') return 0;
            
            // Parse formats like "2h 15m 30s", "5m 30s", "45s"
            let totalSeconds = 0;
            const parts = uptimeString.split(' ');
            
            for (const part of parts) {
                if (part.includes('h')) {
                    totalSeconds += parseInt(part.replace('h', '')) * 3600;
                } else if (part.includes('m')) {
                    totalSeconds += parseInt(part.replace('m', '')) * 60;
                } else if (part.includes('s')) {
                    totalSeconds += parseInt(part.replace('s', ''));
                }
            }
            
            return totalSeconds;
        }
        
        function formatSecondsToUptime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}h ${minutes}m ${secs}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${secs}s`;
            } else {
                return `${secs}s`;
            }
        }
        
        function startUptimeIncrement() {
            // Clear any existing interval
            if (uptimeInterval) {
                clearInterval(uptimeInterval);
            }
            
            // Update uptime every 5 seconds
            uptimeInterval = setInterval(() => {
                currentUptimeSeconds += 5;
                document.getElementById('uptime').textContent = formatSecondsToUptime(currentUptimeSeconds);
            }, 5000);
        }
        
        function stopUptimeIncrement() {
            if (uptimeInterval) {
                clearInterval(uptimeInterval);
                uptimeInterval = null;
            }
        }


        // Load dashboard data
        async function loadDashboard() {
            try {
                // Load health status
                const healthResponse = await fetch('/health');
                const healthData = await healthResponse.json();
                const isOnline = healthData.status === 'ok';
                
                // Update server status
                document.getElementById('server-status').textContent = isOnline ? 'Online' : 'Offline';
                document.getElementById('server-status-indicator').className = 
                    `status-${isOnline ? 'online' : 'offline'}`;
                
                // Sync uptime from backend and start local increment
                if (isOnline && healthData.uptime) {
                    currentUptimeSeconds = parseUptimeToSeconds(healthData.uptime);
                    document.getElementById('uptime').textContent = healthData.uptime;
                    startUptimeIncrement(); // Start local increment every 5 seconds
                } else {
                    document.getElementById('uptime').textContent = 'Offline';
                    stopUptimeIncrement(); // Stop local increment when offline
                }
                
                // Load topics
                const topicsResponse = await fetch('/topics');
                const topicsData = await topicsResponse.json();
                document.getElementById('topic-count').textContent = topicsData.topics ? topicsData.topics.length : 0;
                
                // Load topics into UI
                loadTopics(topicsData.topics || []);
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                
                // Set offline status when health check fails
                document.getElementById('server-status').textContent = 'Offline';
                document.getElementById('server-status-indicator').className = 'status-offline';
                document.getElementById('uptime').textContent = 'Offline';
                stopUptimeIncrement(); // Stop local increment on error
                
                showAlert('Failed to load dashboard data', 'error');
            }
        }

        // Load topics into the UI
        function loadTopics(topics) {
            const topicsContainer = document.getElementById('topics-container');
            const publishSelect = document.getElementById('publish-topic-select');
            const consumeSelect = document.getElementById('consume-topic-select');
            
            // Store current selections before clearing
            const publishValue = publishSelect.value;
            const consumeValue = consumeSelect.value;
            
            // Clear existing content
            topicsContainer.innerHTML = '';
            publishSelect.innerHTML = '<option value="">Select a topic...</option>';
            consumeSelect.innerHTML = '<option value="">Select a topic...</option>';
            
            if (topics.length === 0) {
                topicsContainer.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-4xl mb-4">üìÅ</div>
                        <h3 class="text-lg font-medium text-gray-500 mb-2">No topics found</h3>
                        <p class="text-gray-400">Create your first topic to get started</p>
                    </div>
                `;
                return;
            }
            
            // Create topic cards
            topics.forEach((topic) => {
                const topicCard = createTopicCard(topic);
                topicsContainer.appendChild(topicCard);
                
                // Add to select options
                const option = `<option value="${topic.name}">${topic.name}</option>`;
                publishSelect.insertAdjacentHTML('beforeend', option);
                consumeSelect.insertAdjacentHTML('beforeend', option);
            });
            
            // Restore selections if they still exist
            if (publishValue && topics.some(t => t.name === publishValue)) {
                publishSelect.value = publishValue;
            }
            if (consumeValue && topics.some(t => t.name === consumeValue)) {
                consumeSelect.value = consumeValue;
            }
        }

        // Create topic card
        function createTopicCard(topic) {
            const card = document.createElement('div');
            card.className = 'card p-4';
            
            card.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                            <span class="text-blue-600 font-bold text-sm">üìÅ</span>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-900">${topic.name}</h3>
                            <p class="text-sm text-gray-500">Topic</p>
                        </div>
                    </div>
                    <button onclick="showTopicDetails('${topic.name}')" class="text-gray-400 hover:text-gray-600">
                        ‚ãØ
                    </button>
                </div>
                
                <div class="space-y-1">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">Size:</span>
                        <span class="font-medium">${formatBytes(topic.size || 0)}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">Created:</span>
                        <span class="font-medium">${formatDate(topic.createdAt)}</span>
                    </div>
                </div>
            `;
            
            return card;
        }

        // Topic management functions
        function showCreateTopicModal() {
            document.getElementById('create-topic-modal').style.display = 'flex';
            document.getElementById('new-topic-name').focus();
        }

        function hideCreateTopicModal() {
            document.getElementById('create-topic-modal').style.display = 'none';
            document.getElementById('new-topic-name').value = '';
        }

        async function createTopic() {
            const topicName = document.getElementById('new-topic-name').value.trim();
            
            if (!topicName) {
                showAlert('Please enter a topic name', 'error');
                return;
            }
            
            try {
                const response = await fetch('/topics', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name: topicName })
                });
                
                if (response.ok) {
                    showAlert(`Topic "${topicName}" created successfully`, 'success');
                    hideCreateTopicModal();
                    loadDashboard();
                } else {
                    const errorData = await response.json();
                    showAlert(errorData.message || 'Failed to create topic', 'error');
                }
            } catch (error) {
                console.error('Error creating topic:', error);
                showAlert('Error creating topic', 'error');
            }
        }

        function showDeleteAllTopicsModal() {
            document.getElementById('delete-all-topics-modal').style.display = 'flex';
        }

        function hideDeleteAllTopicsModal() {
            document.getElementById('delete-all-topics-modal').style.display = 'none';
        }

        async function deleteAllTopics() {
            try {
                const response = await fetch('/topics', {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showAlert('All topics deleted successfully', 'success');
                    hideDeleteAllTopicsModal();
                    loadDashboard();
                } else {
                    const errorData = await response.json();
                    showAlert(errorData.message || 'Failed to delete topics', 'error');
                }
            } catch (error) {
                console.error('Error deleting topics:', error);
                showAlert('Error deleting topics', 'error');
            }
        }

        function showTopicDetails(topicName) {
            currentTopicForDeletion = topicName;
            const content = document.getElementById('topic-details-content');
            
            content.innerHTML = `
                <div class="space-y-4">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-4">
                            <span class="text-blue-600 font-bold">üìÅ</span>
                        </div>
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900">${topicName}</h4>
                            <p class="text-sm text-gray-500">Topic Details</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 pt-4">
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <div class="text-sm text-gray-500">Messages</div>
                            <div class="text-lg font-semibold text-gray-900">0</div>
                        </div>
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <div class="text-sm text-gray-500">Size</div>
                            <div class="text-lg font-semibold text-gray-900">0 B</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('topic-details-modal').style.display = 'flex';
        }

        function hideTopicDetailsModal() {
            document.getElementById('topic-details-modal').style.display = 'none';
            currentTopicForDeletion = null;
        }

        async function deleteTopic() {
            if (!currentTopicForDeletion) return;
            
            try {
                const response = await fetch(`/topics/${currentTopicForDeletion}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showAlert(`Topic "${currentTopicForDeletion}" deleted successfully`, 'success');
                    hideTopicDetailsModal();
                    loadDashboard();
                } else {
                    const errorData = await response.json();
                    showAlert(errorData.message || 'Failed to delete topic', 'error');
                }
            } catch (error) {
                console.error('Error deleting topic:', error);
                showAlert('Error deleting topic', 'error');
            }
        }

        // Message operations
        async function publishMessage() {
            const topicSelect = document.getElementById('publish-topic-select');
            const messageInput = document.getElementById('publish-message');
            
            const topic = topicSelect.value;
            const message = messageInput.value.trim();
            
            if (!topic) {
                showAlert('Please select a topic', 'error');
                return;
            }
            
            if (!message) {
                showAlert('Please enter a message', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/topics/${topic}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showAlert(`Message published successfully with offset ${result.offset}`, 'success');
                    messageInput.value = '';
                    loadDashboard();
                } else {
                    const errorData = await response.json();
                    showAlert(errorData.message || 'Failed to publish message', 'error');
                }
            } catch (error) {
                console.error('Error publishing message:', error);
                showAlert('Error publishing message', 'error');
            }
        }

        async function consumeMessage() {
            const topicSelect = document.getElementById('consume-topic-select');
            const offsetInput = document.getElementById('consume-offset');
            
            const topic = topicSelect.value;
            const offset = offsetInput.value || '0';
            
            if (!topic) {
                showAlert('Please select a topic', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/topics/${topic}?offset=${offset}`);
                
                if (response.ok) {
                    const result = await response.json();
                    showAlert(`Message consumed: "${result.message}"`, 'success');
                    loadDashboard();
                } else if (response.status === 404) {
                    showAlert('No message found at the specified offset', 'error');
                } else {
                    const errorData = await response.json();
                    showAlert(errorData.message || 'Failed to consume message', 'error');
                }
            } catch (error) {
                console.error('Error consuming message:', error);
                showAlert('Error consuming message', 'error');
            }
        }

        // Utility functions
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboard();
            
            // Refresh dashboard every 2 minutes (reduced frequency for better performance)
            setInterval(loadDashboard, 120000);
        });
    </script>
</body>
</html>